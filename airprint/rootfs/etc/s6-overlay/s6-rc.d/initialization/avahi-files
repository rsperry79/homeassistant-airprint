#!/command/with-contend bashio

# Avahi paths
readonly avahi_config_path=/config/avahi
readonly avahi_services_path=/config/avahi/services
readonly avahi_templates_path=/config/templates/avahi

readonly src_avahi_templates_path=/usr/templates/avahi
readonly avahi_daemon_cfg=avahi-daemon.conf.tempio
readonly folder_group=avahi

# Avahi config folder
if ! bashio::fs.directory_exists "${avahi_config_path}"; then
  install -d -m 0770 -g "$folder_group" "${avahi_config_path}" ||
    bashio::exit.nok 'Failed to create a persistent Avahi config folder'
fi

# Avahi services  folder
if ! bashio::fs.directory_exists "${avahi_services_path}"; then
  install -d -m 0770 -g "$folder_group" "${avahi_services_path}" ||
    bashio::exit.nok 'Failed to create a persistent Avahi services folder'

  ln -sn "$avahi_services_path" /etc/avahi/services
fi

# avahi templates folder
if ! bashio::fs.directory_exists "${avahi_templates_path}"; then
  install -d -m 0770 -g "$folder_group" "${avahi_templates_path}" ||
    bashio::exit.nok 'Failed to create a persistent avahi templates folder'
fi

if [ ! -e "$avahi_templates_path/$avahi_daemon_cfg".tempio ]; then
  cp "$src_avahi_templates_path/$avahi_daemon_cfg" "$avahi_templates_path/$avahi_daemon_cfg"
fi
