#!/command/with-contend bashio
# shellcheck disable=SC2181

# shellcheck source="../../../../opt/common/paths.sh"
source "/opt/common/paths.sh"

# shellcheck source="../../../../opt/cups/cups-host-helpers.sh"
source "/opt/cups/cups-host-helpers.sh"

# shellcheck source="../../../../opt/cups/cups-ssl-helpers.sh"
source "/opt/cups/cups-ssl-helpers.sh"

# shellcheck source="../../../../opt/cups/cups-config-helpers.sh"
source "/opt/cups/cups-config-helpers.sh"

function run() {
    setup

    if [ ! -e "$real_cups_path/$cups_client_cfg" ]; then
        autoconf_client
    else
        update_client
    fi

    if [ ! -e "$real_cups_path/$cups_daemon_cfg" ]; then
        autoconf_daemon
    else
        update_daemon
    fi

    if [ ! -e "$real_cups_path/$cups_files_cfg" ]; then
        autoconf_files
    else
        update_files
    fi

}

# Gets current settings from HA
function setup() {
    host_name=$(hostname -f)
    add_host_name_to_hosts "$host_name"
    cups_log_level="error"
    cups_access_log_level="config"
    HOST_ALIAS="*"
    self_sign=false

    CUPS_PRIVATE_KEY="$cups_ssl_path/$host_name.crt"
    CUPS_PUBLIC_KEY="$cups_ssl_path/$host_name.pem"

    if bashio::config.has_value 'cups_log_level'; then
        cups_log_level=$(bashio::config 'cups_log_level')
    fi

    if bashio::config.has_value 'cups_access_log_level'; then
        cups_access_log_level=$(bashio::config 'cups_access_log_level')
    fi

    cups_self_sign=no
    if bashio::config.has_value cups_self_sign; then
        self_sign=$(bashio::config 'cups_self_sign')
        bashio::log.debug "Self sign has value: $self_sign"
        if [ "$self_sign" == true ]; then
            cups_self_sign=yes
        fi
    fi

    # setup_ssl "$host_name" "$self_sign"

    # Used by autoconf
    config=$(jq --arg host_name "$host_name" \
        --arg privkey "$CUPS_PRIVATE_KEY" --arg pubkey "$CUPS_PUBLIC_KEY" --arg cups_log_level "$cups_log_level" \
        --arg cups_access_log_level "$cups_access_log_level" --arg host_alias "$HOST_ALIAS" --arg self_sign "$cups_self_sign" \
        '{ host_name: $host_name,  host_alias: $host_alias , privkey: $privkey, pubkey: $pubkey, cups_log_level: $cups_log_level, cups_access_log_level: $cups_access_log_level, self_sign: $self_sign   }' \
        /data/options.json)
}

function autoconf_client() {
    echo "$config" | tempio \
        -template "$cups_templates_path/$cups_client_cfg" \
        -out "$real_cups_path/$cups_client"
}

function update_client() {
    echo
    # update_server_name "$host_name"
}

function autoconf_daemon() {
    # if [ ! -e "$real_cups_path/$cups_daemon_cfg" ]; then
    echo "$config" | tempio \
        -template "$cups_templates_path/$cups_daemon_cfg" \
        -out "$real_cups_path/$cups_daemon"
    # fi
}

function update_daemon() {
    echo
    # update_log_level "$cups_log_level"
    # update_server_alias "$HOST_ALIAS"
    # update_server_name "$host_name"
}

function autoconf_files() {
    echo "$config" | tempio \
        -template "$cups_templates_path/$cups_files_cfg" \
        -out "$real_cups_path/$cups_files"
}

function update_files() {
    echo
    # update_access_log_level "$cups_access_log_level"
    # update_self_sign "$self_sign"
    # update_public_key "$CUPS_PUBLIC_KEY"
    # update_private_key "$CUPS_PRIVATE_KEY"
}

run
