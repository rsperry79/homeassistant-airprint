#!/command/with-contend bashio
# shellcheck disable=SC2181

# shellcheck source="../../../../opt/helpers/cups-host-helpers.sh"
source "/opt/helpers/cups-host-helpers.sh"
# shellcheck source="../../../../opt/helpers/cups-ssl-helpers.sh"
source "/opt/helpers/cups-ssl-helpers.sh"

# shellcheck source="../../../../opt/helpers/cups-ssl-helpers.sh"
source "/opt/helpers/cups-ssl-helpers.sh"

# HA File paths
readonly real_cups_path=/config/cups

# CUPS paths
readonly cups_templates_path=/config/templates/cups
readonly cups_client_cfg=client.conf
readonly cups_daemon_cfg=cupsd.conf
readonly cups_files_cfg=cups-files.conf

function run() {
    setup

    if [ ! -e "$real_cups_path/$cups_client_cfg" ]; then
        autoconf_client
    else
        update_client
    fi

    if [ ! -e "$real_cups_path/$cups_daemon_cfg" ]; then
        autoconf_daemon
    else
        update_daemon
    fi

    if [ ! -e "$real_cups_path/$cups_files_cfg" ]; then
        autoconf_files
    else
        update_files
    fi

}

# Gets current settings from HA
function setup() {
    host_name=$(hostname -f)

    cups_log_level="error"
    cups_access_log_level="config"
    HOST_ALIAS="*"
    self_sign=false

    if bashio::config.has_value 'cups_log_level'; then
        cups_log_level=$(bashio::config 'cups_log_level')
    fi

    if bashio::config.has_value 'cups_access_log_level'; then
        cups_access_log_level=$(bashio::config 'cups_access_log_level')
    fi
    if bashio::config.has_value cups_self_sign; then
        self_sign=$(bashio::config 'cups_self_sign')
        bashio::log.info "Self sign has value: $self_sign"
    fi

    setup_ssl "$host_name" "$self_sign"

    bashio::log.info "HOST_ALIAS: $HOST_ALIAS"
    # Used by autoconf
    config=$(jq --arg host_name "$host_name" \
        --arg privkey "$privkey" --arg pubkey "$pubkey" --arg cups_log_level "$cups_log_level" \
        --arg cups_access_log_level "$cups_access_log_level" --arg host_alias "$HOST_ALIAS" --arg self_sign "$self_sign" \
        '{ host_name: $host_name,  host_alias: $host_alias , privkey: $privkey, pubkey: $pubkey, cups_log_level: $cups_log_level, cups_access_log_level: $cups_access_log_level, self_sign: $self_sign   }' \
        /data/options.json)
}

function autoconf_client() {
    echo "$config" | tempio \
        -template "$cups_templates_path/$cups_client_cfg.tempio" \
        -out "$real_cups_path/$cups_client_cfg"
}

function update_client() {
    sed -i "s/^.*ServerName .*/ServerName ${host_name}:631/" "$real_cups_path/$cups_daemon_cfg"
}

function autoconf_daemon() {
    # if [ ! -e "$real_cups_path/$cups_daemon_cfg" ]; then
    echo "$config" | tempio \
        -template "$cups_templates_path/$cups_daemon_cfg.tempio" \
        -out "$real_cups_path/$cups_daemon_cfg"
    # fi
}

function update_daemon() {
    sed -i "s/^.*LogLevel .*/LogLevel ${cups_log_level}/" "$real_cups_path/$cups_daemon_cfg"
    sed -i "s/^.*ServerName .*/ServerName ${host_name}/" "$real_cups_path/$cups_daemon_cfg"
    sed -i "s/^.*ServerAlias .*/ServerAlias ${HOST_ALIAS}/" "$real_cups_path/$cups_daemon_cfg"
}

function autoconf_files() {
    echo "$config" | tempio \
        -template "$cups_templates_path/$cups_files_cfg.tempio" \
        -out "$real_cups_path/$cups_files_cfg"
}

function update_files() {
    bashio::log.red "AccessLogLevel"
    sed -i "s#^.*AccessLogLevel .*#AccessLogLevel ${cups_access_log_level}#" "$real_cups_path/$cups_files_cfg"

    bashio::log.red "CreateSelfSignedCerts"
    #sed -i "s#^.*CreateSelfSignedCerts .*CreateSelfSignedCerts ${self_sign}#" "$real_cups_path/$cups_files_cfg"

    bashio::log.red "ServerCertificate"
    # sed -i "s#^.*ServerCertificate .*ServerCertificate ${pubkey}#" "$real_cups_path/$cups_files_cfg"

    bashio::log.red "ServerKey"
    #sed -i "s#^.*ServerKey .*ServerKey ${privkey}#" "$real_cups_path/$cups_files_cfg"
    bashio::log.red "update_files"
}

run
