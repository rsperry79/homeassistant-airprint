#!/command/with-contend bashio
# shellcheck disable=SC2181

# HA File paths
readonly real_cups_path=/config/cups

# CUPS paths
readonly cups_templates_path=/config/templates/cups
readonly cups_client_cfg=client.conf
readonly cups_daemon_cfg=cupsd.conf
readonly cups_files_cfg=cups-files.conf
readonly ssl_dir="/config/cups/ssl"

readonly ssl_owner="root"
readonly ssl_group="root"
readonly ssl_perms="770"

function run() {
    setup

    if [ ! -e "$real_cups_path/$cups_client_cfg" ]; then
        autoconf_client
    else
        update_client
    fi

    if [ ! -e "$real_cups_path/$cups_daemon_cfg" ]; then
        autoconf_daemon
    else
        update_daemon
    fi

    if [ ! -e "$real_cups_path/$cups_files_cfg" ]; then
        autoconf_files
    else
        update_files
    fi

}

# Gets current settings from HA
function setup() {
    host_name=$(hostname -f)

    cups_log_level="error"
    cups_access_log_level="config"
    host_alias="*"

    if bashio::config.has_value 'cups_log_level'; then
        cups_log_level=$(bashio::config 'cups_log_level')
    fi

    if bashio::config.has_value 'cups_access_log_level'; then
        cups_access_log_level=$(bashio::config 'cups_access_log_level')
    fi

    setup_ssl

    # Used by autoconf
    config=$(jq --arg host_name "$host_name" \
        --arg privkey "$privkey" --arg pubkey "$pubkey" --arg cups_log_level "$cups_log_level" \
        --arg cups_access_log_level "$cups_access_log_level" --arg host_alias "$host_alias" --arg self_sign "$self_sign" \
        '{ host_name: $host_name,  host_alias: $host_alias , privkey: $privkey, pubkey: $pubkey, cups_log_level: $cups_log_level, cups_access_log_level: $cups_access_log_level, self_sign: $self_sign   }' \
        /data/options.json)
}

function setup_ssl() {
    # TODO MOVE
    # if [ -d "$ssl_dir" ]; then
    #     rm -f "$ssl_dir"/*
    # fi

    sign=$(bashio::config cups_self_sign)
    bashio::log.info self sign has value: "$sign"

    if bashio::config.has_value cups_self_sign && bashio::config.true 'cups_self_sign'; then
        bashio::log.info "Self sign is on"

        self_sign=yes
        privkey="$ssl_dir/$host_name.crt"
        pubkey="$ssl_dir/$host_name.pem"
    else
        bashio::log.info "Self sign is off"

        self_sign=no
        rm -f "$ssl_dir/*"
        setup_ssl_public
        setup_ssl_private
    fi

}

function setup_ssl_private() {
    privkey="/ssl/privkey.pem"
    if bashio::config.has_value 'cups_ssl_key'; then
        privkey=$(bashio::config 'cups_ssl_key')
    elif [ -e "/ssl/privkey.pem" ]; then
        privkey="/ssl/privkey.pem"
    else
        privkey=""
    fi

    if [ ! -e "$privkey" ]; then
        bashio::log.notice "SSL Private key does not exist at given path"
    else
        convert_private_key
    fi
}

function setup_ssl_public() {
    if bashio::config.has_value 'cups_ssl_cert'; then
        pubkey=$(bashio::config 'cups_ssl_cert')
    elif [ -e "/ssl/fullchain.pem" ]; then
        pubkey="/ssl/fullchain.pem"
    else
        pubkey=""
    fi

    if [ ! -e "$pubkey" ]; then
        bashio::log.notice "SSL Public key does not exist at given path"
    else
        update_hosts
        convert_public_key
    fi
}

function convert_private_key() {
    rm -f "$ssl_dir/$host_name.key"
    msg=$(openssl rsa -in "$privkey" -out "$ssl_dir/$host_name.key")
    if [ $? -eq 0 ]; then
        chown "$ssl_owner":"$ssl_group" "$ssl_dir/$host_name.key"
        chmod "$ssl_perms" "$ssl_dir/$host_name.key"
        privkey="$ssl_dir/$host_name.key"
        bashio::log.debug "SSL Private Key exists. $privkey"
    else
        bashio::log.error "Private key is not valid. $msg"
    fi
}
function convert_public_key() {
    rm -f "$ssl_dir/$host_name.crt"
    msg=$(openssl x509 -in "$pubkey" -out "$ssl_dir/$host_name.crt")
    if [ $? -eq 0 ]; then
        chown "$ssl_owner":"$ssl_group" "$ssl_dir/$host_name.crt"
        chmod "$ssl_perms" "$ssl_dir/$host_name.crt"
        pubkey="$ssl_dir/$host_name.crt"
        bashio::log.debug "SSL Public Key exists. $pubkey"
    else
        bashio::log.error "Public key is not valid. $msg"
    fi
}

function update_hosts() {
    cn=$(openssl x509 -noout -subject -in "$pubkey" -nameopt multiline | awk -F' = ' '/commonName/ {print $2}')
    host_alias="${cn#"${cn%%[![:space:]]*}"}"
    add_host_name_to_hosts "$host_alias"

    add_sans "$pubkey"
}

function add_host_name_to_hosts() {
    host_alias=${1}

    if ! grep "$host_alias" /etc/hosts; then
        bashio::log.info "Adding host is $host_alias to /etc/hosts"
        echo "127.0.0.1 $host_alias" >>/etc/hosts
    fi
}

function add_sans() {
    cert=${1}
    sans=$(openssl x509 -noout -text -in "$cert" | grep DNS: | tail -n1 | sed 's/DNS://g; s/, / /g')
    trimmed="${sans#"${sans%%[![:space:]]*}"}"

    set -f
    IFS=' ' read -r -a names <<<"$trimmed"
    set +f

    for name in "${!names[@]}"; do
        add_host_name_to_hosts "${names[name]}"
        if ! echo "$host_alias" | grep "$name"; then
            host_alias+=$name
        fi
    done
}

function autoconf_client() {
    echo "$config" | tempio \
        -template "$cups_templates_path/$cups_client_cfg.tempio" \
        -out "$real_cups_path/$cups_client_cfg"
}

function update_client() {
    sed -i "s/^.*ServerName .*/ServerName ${host_name}:631/" "$real_cups_path/$cups_daemon_cfg"
}

function autoconf_daemon() {
    # if [ ! -e "$real_cups_path/$cups_daemon_cfg" ]; then
    echo "$config" | tempio \
        -template "$cups_templates_path/$cups_daemon_cfg.tempio" \
        -out "$real_cups_path/$cups_daemon_cfg"
    # fi
}

function update_daemon() {
    sed -i "s/^.*LogLevel .*/LogLevel ${cups_log_level}/" "$real_cups_path/$cups_daemon_cfg"
    sed -i "s/^.*ServerName .*/ServerName ${host_name}/" "$real_cups_path/$cups_daemon_cfg"
    sed -i "s/^.*ServerAlias .*/ServerAlias ${host_alias}/" "$real_cups_path/$cups_daemon_cfg"
}

function autoconf_files() {

    echo "$config" | tempio \
        -template "$cups_templates_path/$cups_files_cfg.tempio" \
        -out "$real_cups_path/$cups_files_cfg"
}

function update_files() {
    sed -i "s/^.*AccessLogLevel .*/AccessLogLevel ${cups_access_log_level}/" "$real_cups_path/$cups_files_cfg"
    sed -i "s#^.*ServerCertificate .*#ServerCertificate ${pubkey}#" "$real_cups_path/$cups_files_cfg"
    sed -i "s#^.*ServerKey .*#ServerKey ${privkey}#" "$real_cups_path/$cups_files_cfg"
    sed -i "s#^.*CreateSelfSignedCerts .*#CreateSelfSignedCerts ${self_sign}#" "$real_cups_path/$cups_files_cfg"
}

run
