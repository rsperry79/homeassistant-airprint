#!/usr/bin/with-contenv bashio
# shellcheck disable=SC2034

# shellcheck source="../../src/common/paths/nginx-paths.sh"
source "/opt/common/paths/nginx-paths.sh"

ulimit -n 524288

function run() {
    bashio::log.info "NGINX Path $nginx_config_path/$nginx_default $nginx_config_path/$nginx_conf"
    /usr/bin/inotifywait -m -e close_write,moved_to,create "$nginx_config_path" |
        while read -r directory events filename; do
            bashio::log.info "NGINX Runner FNAME: $filename"
            if [ "$filename" = "$nginx_default" ] || [ "$filename" = "$nginx_conf" ]; then
                bashio::log.info "Getting NGINX IPs"
                bashio /opt/helpers/nginx-ip-helper.sh

                bashio::log.info "Testing NGINX server config"
                nginx -t

                bashio::log.info "Starting NGINX server from S6"
                nginx             # -g "daemon off;"
                tail -f /dev/null # Keep Running
            fi
        done
}

run
